<?php

namespace Ecotone\AnnotationFinder\AnnotationResolver;

use Ecotone\AnnotationFinder\AnnotationResolver;
use Ecotone\AnnotationFinder\ConfigurationException;
use Ecotone\AnnotationFinder\TypeResolver;
use Ecotone\Messaging\Attribute\IsAbstract;
use ReflectionAttribute;
use ReflectionClass;
use ReflectionException;
use ReflectionProperty;

class AttributeResolver implements AnnotationResolver
{
    /**
     * @inheritDoc
     */
    public function getAnnotationsForMethod(string $className, string $methodName): array
    {
        try {
            $analyzedClass = new ReflectionClass($className);
            $reflectionMethod = TypeResolver::getMethodOwnerClass($analyzedClass, $methodName)->getMethod($methodName);

            return array_reduce($reflectionMethod->getAttributes(), function (array $carry, ReflectionAttribute $attribute) {
                if (! class_exists($attribute->getName())) {
                    return $carry;
                }

                $carry[] = $attribute->newInstance();

                return $carry;
            }, []);
        } catch (ReflectionException $e) {
            throw ConfigurationException::create("Class {$className} with method {$methodName} does not exists or got annotation configured wrong: " . $e->getMessage());
        }
    }

    /**
     * @inheritDoc
     */
    public function getAnnotationsForClass(string $className): array
    {
        $analyzedClass = new ReflectionClass($className);
        $attributes = array_reduce(($analyzedClass)->getAttributes(), function (array $carry, ReflectionAttribute $attribute) {
            if (! class_exists($attribute->getName())) {
                return $carry;
            }

            $carry[] = $attribute->newInstance();

            return $carry;
        }, []);

        if ($analyzedClass->isAbstract() && ! $analyzedClass->isInterface()) {
            $attributes[] = new IsAbstract();
        }

        return $attributes;
    }

    /**
     * @inheritDoc
     */
    public function getAnnotationsForProperty(string $className, string $propertyName): array
    {
        $reflectionClass = new ReflectionClass($className);
        $parentClass = $reflectionClass;

        do {
            foreach ($parentClass->getProperties() as $property) {
                if ($property->getName() !== $propertyName) {
                    continue;
                }

                return array_reduce((new ReflectionProperty($className, $propertyName))->getAttributes(), function (array $carry, ReflectionAttribute $attribute) {
                    if (! class_exists($attribute->getName())) {
                        return $carry;
                    }

                    $carry[] = $attribute->newInstance();

                    return $carry;
                }, []);
            }
        } while ($parentClass = $parentClass->getParentClass());

        throw ConfigurationException::create("Can't resolve property {$propertyName} for class {$className}");
    }
}
